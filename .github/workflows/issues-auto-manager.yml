name: ğŸ› ï¸ Issues Manager

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  # Re also listen to comments, to remove stale labels right away
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  label-on-content:
    name: ğŸ·ï¸ Label Issues by Content
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Mint App Token
        id: app
        # Create a GitHub App token
        # https://github.com/marketplace/actions/create-github-app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.ST_BOT_APP_ID }}
          private-key: ${{ secrets.ST_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Repository
        # Checkout
        # https://github.com/marketplace/actions/checkout
        uses: actions/checkout@v4.2.2

      - name: Auto-Label Issues (Based on Issue Content)
        # only auto label based on issue content once, on open (to prevent re-labeling removed labels)
        if: github.event.action == 'opened'

        # Issue Labeler
        # https://github.com/marketplace/actions/regex-issue-labeler
        uses: github/issue-labeler@v3.4
        with:
          configuration-path: .github/issues-auto-labels.yml
          enable-versioned-regex: 0
          repo-token: ${{ steps.app.outputs.token }}

  label-on-labels:
    name: ğŸ·ï¸ Label Issues by Labels
    needs: [label-on-content]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Mint App Token
        id: app
        # Create a GitHub App token
        # https://github.com/marketplace/actions/create-github-app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.ST_BOT_APP_ID }}
          private-key: ${{ secrets.ST_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: âœ… Add "ğŸ‘ Approved" for relevant labels
        if: contains(fromJSON('["ğŸ‘©â€ğŸ’» Good First Issue", "ğŸ™ Help Wanted", "ğŸª² Confirmed", "âš ï¸ High Priority", "â• Medium Priority", "ğŸ’¤ Low Priority"]'), github.event.label.name)
        # ğŸ¤– Issues Helper
        # https://github.com/marketplace/actions/issues-helper
        uses: actions-cool/issues-helper@v3.6.0
        with:
          actions: 'add-labels'
          token: ${{ steps.app.outputs.token }}
          labels: 'ğŸ‘ Approved'

      - name: âŒ Remove progress labels when issue is marked done or stale
        if: contains(fromJSON('["âœ… Done", "âœ… Done (staging)", "âš°ï¸ Stale", "âŒ wontfix"]'), github.event.label.name)
        # ğŸ¤– Issues Helper
        # https://github.com/marketplace/actions/issues-helper
        uses: actions-cool/issues-helper@v3.6.0
        with:
          actions: 'remove-labels'
          token: ${{ steps.app.outputs.token }}
          labels: 'ğŸ§‘â€ğŸ’» In Progress,ğŸ¤” Unsure,ğŸ¤” Under Consideration'

      - name: âŒ Remove temporary labels when confirmed labels are added
        if: contains(fromJSON('["âŒ wontfix","ğŸ‘ Approved","ğŸ‘©â€ğŸ’» Good First Issue"]'), github.event.label.name)
        # ğŸ¤– Issues Helper
        # https://github.com/marketplace/actions/issues-helper
        uses: actions-cool/issues-helper@v3.6.0
        with:
          actions: 'remove-labels'
          token: ${{ steps.app.outputs.token }}
          labels: 'ğŸ¤” Unsure,ğŸ¤” Under Consideration'

      - name: âŒ Remove no bug labels when "ğŸª² Confirmed" is added
        if: github.event.label.name == 'ğŸª² Confirmed'
        # ğŸ¤– Issues Helper
        # https://github.com/marketplace/actions/issues-helper
        uses: actions-cool/issues-helper@v3.6.0
        with:
          actions: 'remove-labels'
          token: ${{ steps.app.outputs.token }}
          labels: 'âœ–ï¸ Not Reproducible,âœ–ï¸ Not A Bug'

  remove-stale-label:
    name: ğŸ—‘ï¸ Remove Stale Label on Comment
    needs: [label-on-content, label-on-labels]
    runs-on: ubuntu-latest
    # Only run this on new comments, to automatically remove the stale label
    if: always() && (github.event_name == 'issue_comment' && github.event.sender.type != 'Bot')

    steps:
      - name: Mint App Token
        id: app
        # Create a GitHub App token
        # https://github.com/marketplace/actions/create-github-app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.ST_BOT_APP_ID }}
          private-key: ${{ secrets.ST_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Remove Stale Label
        # ğŸ¤– Issues Helper
        # https://github.com/marketplace/actions/issues-helper
        uses: actions-cool/issues-helper@v3.6.0
        with:
          actions: 'remove-labels'
          token: ${{ steps.app.outputs.token }}
          issue-number: ${{ github.event.issue.number }}
          labels: 'âš°ï¸ Stale,ğŸ•¸ï¸ Inactive,ğŸš Awaiting User Response,ğŸ›‘ No Response'

  write-auto-comments:
    name: ğŸ’¬ Post Issue Comments Based on Labels
    needs: [label-on-content, label-on-labels, remove-stale-label]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Mint App Token
        id: app
        # Create a GitHub App token
        # https://github.com/marketplace/actions/create-github-app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.ST_BOT_APP_ID }}
          private-key: ${{ secrets.ST_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Repository
        # Checkout
        # https://github.com/marketplace/actions/checkout
        uses: actions/checkout@v4.2.2

      - name: Post Issue Comments Based on Labels
        # Label Commenter
        # https://github.com/marketplace/actions/label-commenter
        uses: peaceiris/actions-label-commenter@v1.10.0
        with:
          config_file: .github/issues-auto-comments.yml
          github_token: ${{ steps.app.outputs.token }}
